<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Web Audio API examples: OfflineAudioContext (using promises)</title>
  </head>

  <body>
    <h1>Web Audio API examples: OfflineAudioContext (using promises)</h1>
    <button id="play" disabled="true">Play</button>
  </body>
  <script>
    // Define both online and offline audio contexts
    const audioCtx = new AudioContext();
    const offlineCtx = new OfflineAudioContext(2, 44100 * 40, 44100);

    // Define constants for dom nodes
    const play = document.querySelector("#play");

    // use XHR to load an audio track, and
    // decodeAudioData to decode it and stick it in a buffer.
    // Then we put the buffer into the source

    function getData() {
      request = new XMLHttpRequest();

      request.open("GET", "viper.ogg", true);

      request.responseType = "arraybuffer";

      request.onload = () => {
        audioCtx.decodeAudioData(request.response).then((downloadedBuffer) => {
          console.log("File downloaded.successfully.");
          const source = new AudioBufferSourceNode(offlineCtx, {
            buffer: downloadedBuffer,
          });
          source.connect(offlineCtx.destination);
          source.start();

          offlineCtx
            .startRendering()
            .then((renderedBuffer) => {
              console.log("Rendering completed successfully.");
              play.disabled = false;
              const song = new AudioBufferSourceNode(audioCtx, {
                buffer: renderedBuffer,
              });
              song.connect(audioCtx.destination);

              play.onclick = () => {
                song.start();
                play.disabled = true;
              };
            })
            .catch((err) => {
              console.error(`Rendering failed: ${err}`);
            });
        })
        .catch((err) => {
          console.error(`Download error: ${err}`);
        });
      };

      request.send();
    }

    // Run getData to start the process off

    getData();
  </script>
</html>
